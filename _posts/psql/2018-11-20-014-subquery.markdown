---
layout: post
title: "Sub Query dalam PostgreSQL"
date: 2018-11-20T14:25:44+07:00
lang: psql
categories:
- RDBMS
- PostgreSQL
refs: []
youtube: https://www.youtube.com/watch?v=ed7haJRjqKY&list=PLV1-tdmPblvypZXSk2GC932nludT345xk&index=21
comments: true
---

SubQuery atau istilah nya query dalam query. SubQuery bisa diterapkan di `column` dan di `where close`. Berikut contohnya:

**Penempatan pada `select ...`**

{% highlight sql linenos %}
select
    e.employee_id as nik,
    e.first_name as nama,
    (select j.job_title from jobs j where j.job_id = e.job_id) as jabatan,
    (select j2.min_salary from jobs j2 where j2.job_id = e.job_id) as minimun_salary
from employees e
limit 10;
{% endhighlight %}

Berikut hasilnya:

```postgresql-console
 nik |   nama    |            jabatan            | minimun_salary 
-----+-----------+-------------------------------+----------------
 100 | Steven    | President                     |          20000
 101 | Neena     | Administration Vice President |          15000
 102 | Lex       | Administration Vice President |          15000
 103 | Alexander | Programmer                    |           4000
 104 | Bruce     | Programmer                    |           4000
 105 | David     | Programmer                    |           4000
 106 | Valli     | Programmer                    |           4000
 107 | Diana     | Programmer                    |           4000
 108 | Nancy     | Finance Manager               |           8200
 109 | Daniel    | Accountant                    |           4200
(10 rows)
```

**Penempatan pada `where ...`**

{% highlight sql linenos %}
select
    e.employee_id as nik,
    e.first_name as nama,
    e.salary as gaji_sebulan
from 
    employees e
where 
    e.salary > (select avg(j.max_salary) from jobs j)
limit 10;
{% endhighlight %}

Berikut hasilnya:

```postgresql-console
 nik |  nama  | gaji_sebulan 
-----+--------+--------------
 100 | Steven |     24000.00
 101 | Neena  |     17000.00
 102 | Lex    |     17000.00
 145 | John   |     14000.00
 146 | Karen  |     13500.00
(5 rows)
```

**Penempatan pada `where ...` (lanjutan) menggunakan Operator = Any**

```sql
select 
    job_id as id,
    round(
        avg(j.max_salary)
    ) as gaji_rata 
from 
    jobs j 
group by j.job_id;
```

Akan menghasilkan data berikut:

```postgresql-console
     id     | gaji_rata 
------------+-----------
 AD_VP      |     30000
 ST_MAN     |      8500
 HR_REP     |      9000
 PR_REP     |     10500
 ST_CLERK   |      5000
 FI_MGR     |     16000
 AD_PRES    |     40000
 MK_MAN     |     15000
 FI_ACCOUNT |      9000
 SA_REP     |     12000
 MK_REP     |      9000
 SH_CLERK   |      5500
 AC_ACCOUNT |      9000
 AC_MGR     |     16000
 PU_MAN     |     15000
 PU_CLERK   |      5500
 AD_ASST    |      6000
 IT_PROG    |     10000
 SA_MAN     |     20000
(19 rows)
```

{% highlight sql linenos %}
select
    e.employee_id as nik,
    e.first_name as nama,
    e.salary as gaji_sebulan
from 
    employees e
where 
    e.salary = any (
        select 
            round(avg(j.max_salary)) as gaji_rata 
        from jobs j 
        group by j.job_id
    );
{% endhighlight %}

Berikut hasilnya:

```postgresql-console
 nik |   nama    | gaji_sebulan 
-----+-----------+--------------
 103 | Alexander |      9000.00
 104 | Bruce     |      6000.00
 108 | Nancy     |     12000.00
 109 | Daniel    |      9000.00
 147 | Alberto   |     12000.00
 149 | Eleni     |     10500.00
 150 | Peter     |     10000.00
 152 | Peter     |      9000.00
 156 | Janette   |     10000.00
 158 | Allan     |      9000.00
 162 | Clara     |     10500.00
 169 | Harrison  |     10000.00
 202 | Pat       |      6000.00
 204 | Hermann   |     10000.00
 205 | Shelley   |     12000.00
(15 rows)
```

Atau sebenarnya ini kita bisa menggunakan operator `IN`.

**Penempatan pada `where ...` (lanjutan) menggunakan Operator > Any**

```sql
select 
    round(avg(j.max_salary)) as gaji_rata 
from jobs j 
group by j.job_id
having avg(j.max_salary) < 20000;
```

Berikut hasilquerynya;

```postgresql-console
 gaji_rata 
-----------
      8500
      9000
     10500
      5000
     16000
     15000
      9000
     12000
      9000
      5500
      9000
     16000
     15000
      5500
      6000
     10000
(16 rows)
```

{% highlight sql linenos %}
select
    e.employee_id as nik,
    e.first_name as nama,
    e.salary as gaji_sebulan
from 
    employees e
where 
    e.salary > any (
        select 
            round(avg(j.max_salary)) as gaji_rata 
        from jobs j 
        group by j.job_id
        having avg(j.max_salary) < 20000
    );
{% endhighlight %}

Berikut hasilnya:

```postgresql-console
 nik |    nama     | gaji_sebulan 
-----+-------------+--------------
 100 | Steven      |     24000.00
 101 | Neena       |     17000.00
 102 | Lex         |     17000.00
 103 | Alexander   |      9000.00
 104 | Bruce       |      6000.00
 108 | Nancy       |     12000.00
 109 | Daniel      |      9000.00
 153 | Christopher |      8000.00
 154 | Nanette     |      7500.00
 155 | Oliver      |      7000.00
 ...
(58 rows)
```